---
title: "raw_data_import"
output: html_document
date: "2026-02-05"
---

## The Data

We are using private data from hospitals for research purposes. The raw count matrices are available upon request.

| Sample | Species | Condition | Patient ID | 
|--------|---------|-----------|------------|
| JMY_Ca | Human   | T         | JMY        |
| JMY_N  | Human   | TME       | JMY        |
| WHG_Ca | Human   | T         | WHG        |
| WHG_N  | Human   | TME       | WHG        |
| XDL_Ca | Human   | T         | XDL        |
| XDL_N  | Human   | TME       | XDL        |

### Experimental Design

The general experimental design was as follows:

tumor vs tumor microenvironment (TME) from three patients, 6 samples in total. At tumor site, cells were more likely to be epithelial-like cells, while at TME they are more likely to be immune cells. We want to investigate inter-patient tumor heterogeneity and characterization of immuno-suppression in the tumor microenvironment.

Load the package from your R library. We will also go ahead and load packages from the tidyverse. 
```{r}
library(Seurat)
library(tidyverse)
```

### Importing Data 

We are trying to import the available count data that was saved as a `.txt`, `.tsv`, or `.csv` file. We can import these data using regular base R import functions (e.g., `read.table()`, `read.csv()`). The data does not need to be in a sparse format to create a Seurat object.

To read multiple files, you can use a for loop or a function(s) from the apply family.

```{r}
#List files 
files <- list.files(path="../data/",recursive=T,pattern="*.csv")

#Create a list of count matrices
csv_read <- lapply(paste0("../data/",
                         files), function(file) {
                           counts <- read.csv(file, comment.char = "#", row.names = 1)
                           counts <- t(counts)
                         })

#Automated way to assign names; modify for your purposes   
names(csv_read)<- sapply(files,
                       function(x){paste(str_split_1(x,"_")[1],
                                         str_split_1(x,"_")[2],sep = "_")
                         },
                       USE.NAMES = FALSE)

#Assign names manually
# names(csv_read)<-c("JMY_Ca","JMY_N","WHG_Ca","WHG_N","XDL_Ca","XDL_N")

```

### Creating a Seurat Object  
Once we have read in the matrices, the next step is to create a Seurat object. The Seurat object will be used to store the raw count matrices, sample information, and processed data (normalized counts, plots, etc.).  
  
`CreateSeuratObject()` is used to create the object. This requires the matrix of counts for the first argument. We can also include a project name (e.g., the sample name). Other useful arguments include `min.cells` and `min.features`, which allow some initial filtering. For example, `min.cells = 3` will filter genes / features that are not present across a minimum of 3 cells, while `min.feature=200` will filter cells that do not contain a minimum of 200 genes / features.   

For all samples, we can use `mapply` to loop through the `csv_read` list and the list names (`names(csv_read)`).  

```{r}

# All samples
obj <- mapply(CreateSeuratObject,counts=csv_read,  
              project=names(csv_read),
              MoreArgs = list(min.cells = 3, min.features = 200))
# View obj 
obj
#remove the original matrices
rm(csv_read)

```

We can merge our seurat objects, which are now in a list in order to view the QC metrics and compare across samples. If samples are fairly different, **QC thresholds should be applied on a per sample basis**.
```{r}
obj <- merge(obj[[1]], y = obj[2:length(obj)], 
                  add.cell.ids = names(obj), project="TBSCC")

```
The cell IDs can overlap between samples, so here we can apend the sample ID as a prefix to each cell ID using `add.cell.ids`.

#### Use a for loop to load the data and create an object for each file  

If you want to apply QC metrics independently for each sample, you can use this for loop to create an individual object for each sample.  
```{r}
#| eval: false

# Create a Seurat object for each sample
for (file in files){
        seurat_data <- Read10X_h5(paste0("../GEO_data/",
                         file))
        seurat_obj <- CreateSeuratObject(counts = seurat_data, 
                                         min.features = 200, 
                                         min.cells = 3,
                                         project = file)
        assign(file, seurat_obj)
}

```
### Inspect and work with a Seurat object 

We can access the metadata using:

```{r}
head(obj@meta.data) #using head to return only the first 6 rows  
```
or  
```{r}
head(obj[[]])  
```

Accessing a column or columns:  
```{r}
#Access a single column. 
head(obj$orig.ident)
head(obj[["orig.ident"]])

#Access multiple columns, rows. 
head(obj[[c("orig.ident", "nCount_RNA")]])[1:3,]
```
 
As we can see, there are different ways to access and work with the metadata. In addition, we can see that we begin with built-in information such as the `orig.ident`, `nCount_RNA`, and `nFeature_RNA`.    

`orig.ident` - defaults to the project labels  
`nCount_RNA` - number of UMIs per cell  
`nFeature_RNA` - number of genes / features per cell   

This information, along with other metrics, will be used for quality filtering.     
#### Add to metadata.  

We can add information to our metadata by accessing and assigning to metadata columns or using `?AddMetaData()`. 

Add condition to metadata (either tumor of tumor microenvironment). 
```{r}
obj$condition <- ifelse(str_detect(obj@meta.data$orig.ident, "Ca"),
                        "T","TME")


```

Add patient information to the metadata. 
```{r}
obj$patient_id <- sapply(obj$orig.ident, 
                         function(x){str_split_1(x,"_")[1]},
                         USE.NAMES = FALSE)

```

To return the number of cells or features use:

```{r}
#return number of cells across all layers
num_cells <- ncol(obj)
#return number of features across all layers
num_features <- nrow(obj)
#to return row by column information
dim(obj)
```


We can also quickly plot the number of cells from the metadata:

```{r}
# Visualize the number of cell counts per sample
raw_cell_counts_per_sample_barplot <- obj@meta.data %>% 
  ggplot(aes(x=orig.ident, fill=orig.ident)) + 
  geom_bar(color="black") +
  stat_count(geom = "text", colour = "black", size = 3.5, 
             aes(label = ..count..),
             position=position_stack(vjust=0.5))+
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5, face="bold")) +
  ggtitle("Number of Cells per Sample")
raw_cell_counts_per_sample_barplot
```

```{r eval=FALSE}
saveRDS(raw_cell_counts_per_sample_barplot, file = "../plots/rds/raw_cell_counts_per_sample_barplot.rds")
ggsave("../plots/single_plots/raw_cell_counts_per_sample_barplot.png",height=5,width=7,dpi=300,units="in")
```

### Save the object

At this point, our Seurat object is fairly large. It is wise
to save this for downstream applications using `saveRDS()`.

```{r}
#| eval: false

saveRDS(obj,"../outputs/merged_Seurat_obj.rds")
```

